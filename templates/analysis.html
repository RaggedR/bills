{% extends "base.html" %}

{% block title %}Analysis - Bills{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Analysis</h1>
</div>

<div class="filter-bar" style="background: white; border-radius: 12px; margin-bottom: 2rem;">
    <label>Transaction Type:</label>
    <select id="typeSelect" onchange="loadAnalysis()">
        <option value="expenses">Expenses</option>
        <option value="income">Income</option>
        <option value="all">All</option>
    </select>
    <label style="margin-left: 2rem;">Chart Type:</label>
    <select id="chartTypeSelect" onchange="updateChartType()">
        <option value="doughnut">Donut Chart</option>
        <option value="pie">Pie Chart</option>
        <option value="bar">Bar Chart</option>
    </select>
</div>

<div class="analysis-grid">
    <div style="display: flex; flex-direction: column; gap: 2rem;">
        <div class="card">
            <div class="card-header">
                <h2>Expenses by Account</h2>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="expenseChart"></canvas>
                </div>
                <div class="chart-legend" id="chartLegend">
                    <!-- Legend generated by JS -->
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>Spending Comparison</h2>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 id="categoryTitle">Select a category</h2>
        </div>
        <div class="category-transactions" id="categoryTransactions">
            <div class="empty-state">
                <p>Click on a chart segment to view transactions</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chart = null;
let barChart = null;
let analysisData = [];
let selectedCategoryIndex = null;

const chartColors = [
    '#ef4444', '#f97316', '#f59e0b', '#eab308',
    '#84cc16', '#22c55e', '#10b981', '#14b8a6',
    '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1',
    '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'
];

function loadAnalysis() {
    const type = document.getElementById('typeSelect').value;

    fetch(`/api/analysis?type=${type}`)
        .then(r => r.json())
        .then(data => {
            analysisData = data;
            renderChart();
            renderBarChart();
            renderLegend();
            selectedCategoryIndex = null;
            document.getElementById('categoryTitle').textContent = 'Select a category';
            document.getElementById('categoryTransactions').innerHTML = `
                <div class="empty-state">
                    <p>Click on a chart segment to view transactions</p>
                </div>
            `;
        });
}

function renderChart() {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    const chartType = document.getElementById('chartTypeSelect').value;

    if (chart) {
        chart.destroy();
    }

    if (analysisData.length === 0) {
        document.getElementById('expenseChart').parentElement.innerHTML = `
            <div class="empty-state">
                <h3>No data</h3>
                <p>Reconcile some transactions first</p>
            </div>
        `;
        return;
    }

    const total = analysisData.reduce((sum, d) => sum + d.total, 0);

    chart = new Chart(ctx, {
        type: chartType === 'bar' ? 'bar' : chartType,
        data: {
            labels: analysisData.map(d => `${d.code} - ${d.name}`),
            datasets: [{
                data: analysisData.map(d => d.total),
                backgroundColor: chartColors.slice(0, analysisData.length),
                borderWidth: chartType === 'bar' ? 0 : 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `$${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    showCategoryTransactions(elements[0].index);
                }
            }
        }
    });
}

function renderBarChart() {
    const ctx = document.getElementById('barChart').getContext('2d');

    if (barChart) {
        barChart.destroy();
    }

    if (analysisData.length === 0) {
        return;
    }

    barChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: analysisData.map(d => d.name),
            datasets: [{
                data: analysisData.map(d => d.total),
                backgroundColor: chartColors.slice(0, analysisData.length),
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `$${context.raw.toFixed(2)}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    ticks: {
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            },
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    showCategoryTransactions(elements[0].index);
                }
            }
        }
    });
}

function renderLegend() {
    const total = analysisData.reduce((sum, d) => sum + d.total, 0);
    const legend = document.getElementById('chartLegend');

    legend.innerHTML = analysisData.map((d, i) => {
        const percentage = ((d.total / total) * 100).toFixed(1);
        return `
            <div class="legend-item" onclick="showCategoryTransactions(${i})" style="cursor: pointer;">
                <div class="legend-color" style="background: ${chartColors[i]}"></div>
                <span style="flex: 1;">${d.code} - ${d.name}</span>
                <span style="color: #64748b;">${percentage}%</span>
                <span style="font-weight: 600;">$${d.total.toFixed(2)}</span>
            </div>
        `;
    }).join('');
}

function showCategoryTransactions(index) {
    selectedCategoryIndex = index;
    const category = analysisData[index];

    document.getElementById('categoryTitle').textContent =
        `${category.code} - ${category.name}`;

    const panel = document.getElementById('categoryTransactions');

    if (!category.transactions || category.transactions.length === 0) {
        panel.innerHTML = `
            <div class="empty-state">
                <p>No transactions in this category</p>
            </div>
        `;
        return;
    }

    panel.innerHTML = category.transactions.map(t => {
        const amount = parseFloat(t.amount);
        return `
            <div class="transaction-item" onclick="goToTransaction('${t.id}')" title="Click to edit in Reconciliation">
                <div class="transaction-info">
                    <div class="transaction-description">${escapeHtml(t.description)}</div>
                    <div class="transaction-date">${formatDate(t.date)}</div>
                </div>
                <div class="transaction-amount">$${Math.abs(amount).toFixed(2)}</div>
            </div>
        `;
    }).join('');
}

function updateChartType() {
    renderChart();
}

function goToTransaction(transactionId) {
    // Navigate to reconciliation page with transaction ID
    window.location.href = `/reconciliation?select=${transactionId}`;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('en-AU', {year: 'numeric', month: 'short', day: 'numeric'});
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initial load
loadAnalysis();
</script>
{% endblock %}
